(i=>{let l,n={settings:{fieldIDs:JSON.parse(wpforms_surveys.field_ids),fieldQueue:"",fieldData:{},charts:{},exportSelects:{}},init(){l=this.settings,Chart.defaults.font.size=14,Chart.register({id:"customCanvasBackgroundColor",beforeDraw(e){var t=e.ctx;t.save(),t.globalCompositeOperation="destination-over",t.fillStyle="white",t.fillRect(0,0,e.width,e.height),t.restore()}}),i(n.ready),n.buildUIActions()},ready(){_.isEmpty(l.fieldIDs)||(l.fieldQueue=l.fieldIDs,_.isEmpty(wpforms_surveys.cache)?n.getFieldData():(n.setFieldCache(wpforms_surveys.cache),n.generateReport()))},initExportChoices(){i(".survey-chart-export").each(function(){var e=i(this),t=e.data("id");l.exportSelects["export_"+t]=new Choices(e[0],{searchEnabled:!1,shouldSort:!1})})},buildUIActions(){i(document).on("click","#wpforms-survey-report .chart-toggle",function(e){e.preventDefault();var t,a,r,e=i(this);e.hasClass("current")||(t=e.data("type"),r=(a=e.closest(".actions")).data("field-id"),a.find(".current").removeClass("current"),e.addClass("current"),l.charts["chart_"+r].destroy(),l.charts["chart_hq_"+r].destroy(),n.generateChart(r,t,l.fieldData["field_"+r].chart.labels,l.fieldData["field_"+r].chart.data,!1),n.generateChart(r,t,l.fieldData["field_"+r].chart.labels,l.fieldData["field_"+r].chart.data,!0))}),i(document).on("change","#wpforms-survey-preview-questions",function(){var e=i(this).val(),e=(l.fieldQueue=[],l.fieldData={},l.fieldIDs=[],l.fieldQueue.push(e),l.fieldIDs.push(e),i("#wpforms-survey-report").empty().prepend(wpforms_surveys.loader),n.getFieldData(),{action:"wpforms_surveys_set_preview_field",nonce:wpforms_admin.nonce,field_id:e,form_id:wpforms_surveys.form_id});i.post(wpforms_admin.ajax_url,e)}),i(document).on("change",".survey-chart-export",function(){var e,t=i(this),a=t.data("id");let r,o,s;"jpg"===t.val()?(r=i(" #chart-"+a+"-hq")[0],(o=r.getContext("2d")).globalCompositeOperation="destination-over",o.fillStyle="rgb(255,255,255)",o.fillRect(0,0,r.scrollWidth,r.scrollHeight),s=r.toDataURL("image/jpeg",1),i("#chart-"+a+"-download").attr("href",s),document.getElementById("chart-"+a+"-download").click()):"pdf"===t.val()?(s=i(" #chart-"+a+"-hq")[0].toDataURL("image/jpeg",1),e={pageSize:"LETTER",content:[{text:l.fieldData["field_"+a].question,fontSize:20,margin:[0,0,0,35]},{image:s,width:530}]},pdfMake.createPdf(e).download("chart-field-"+a+".pdf")):"print"===t.val()&&window.open(wpforms_surveys.print+"&field_id="+a),"1"!==t.val()&&l.exportSelects["export_"+a].setChoiceByValue("1")}),i(document).on("click",".form-details-print-survey-report",function(e){e.preventDefault(),window.open(i(this).attr("href"))}),i(document).on("click","#wpforms-survey-print-close",function(e){e.preventDefault(),window.close()}),i(document).on("click","#wpforms-survey-print",function(e){e.preventDefault(),window.print()}),i(document).on("click","#wpforms-survey-print-preview .question-toggle",function(e){e.preventDefault();var e=i(this),t=e.parent();e.find("i").toggleClass("fa-chevron-down fa-chevron-right"),t.toggleClass("no-print").find(".chart-area, .table-wrap, .stats, .no-answers").toggle()}),i(document).on("htmx:beforeSwap",n.clearCache),i(document).on("htmx:afterSwap",n.ready)},getFieldData(){var e={action:"wpforms_surveys_field_data",nonce:wpforms_admin.nonce,form_id:wpforms_surveys.form_id,field_ids:l.fieldQueue,entry_count:wpforms_surveys.entry_count};i.post(wpforms_admin.ajax_url,e,function(e){e.success?(WPFormsAdmin.debug(e.data),n.setFieldCache(e.data),l.fieldQueue=[],n.generateReport()):(i("#wpforms-survey-loading").remove(),i("#wpforms-survey-report").append(e.data.message))})},setFieldCache(e){for(var t of Object.values(e))l.fieldData["field_"+t.id]=t},clearCache(){wpforms_surveys.cache=!1},decodeHTMLEntities(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value},cacheFieldData(){console.warn('WARNING! Function "WPFormsSurvey.cacheFieldData()" has been deprecated');var e={action:"wpforms_surveys_cache_fields",nonce:wpforms_admin.nonce,field_data:JSON.stringify(l.fieldData),form_id:wpforms_surveys.form_id,field_id:wpforms_surveys.field_id,entry_count:wpforms_surveys.entry_count};i.post(wpforms_admin.ajax_url,e)},generateReport(){i("#wpforms-survey-loading").remove();var e=wp.template("wpforms-question-results");i("#wpforms-survey-report").append(e(l.fieldData)),i.each(l.fieldData,function(e,t){_.isEmpty(t.chart.data)||(n.generateChart(t.id,t.chart.default,t.chart.labels,t.chart.data),n.generateChart(t.id,t.chart.default,t.chart.labels,t.chart.data,!0))}),i(".wpforms-table-sorting").stupidtable(),n.initExportChoices(),"list"===wpforms_surveys.type&&i("#wpforms-survey-preview .btn-wrap").show()},generateChart(t,e,a,r,o){let s=!1;o=o||!1,"bar"===e?s={type:"bar",data:{labels:a,datasets:[{label:"Data",hoverBackgroundColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",data:r}]},options:{responsive:!o,maintainAspectRatio:!1,scales:{x:{grid:{display:!1},ticks:{font:{size:o?20:14},callback(e){e=n.decodeHTMLEntities(this.getLabelForValue(e));return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}},y:{min:0,max:100,ticks:{stepSize:20,color:"#999999",font:{size:o?20:11},callback(e){return e+"%"}}}},plugins:{customCanvasBackgroundColor:{},legend:{display:!1},tooltip:{callbacks:{title(e){return e[0].label},label(e){return e.raw+"% ("+l.fieldData["field_"+t].chart.totals[e.dataIndex]+")"},labelColor(){return{backgroundColor:"#2b8fd2"}}}}}}}:"bar-h"===e?s={type:"bar",data:{labels:a,datasets:[{label:"Data",hoverBackgroundColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",data:r}]},options:{indexAxis:"y",responsive:!o,maintainAspectRatio:!1,scales:{x:{min:0,max:100,ticks:{color:"#999999",font:{size:o?20:11},callback(e){return e+"%"}}},y:{grid:{display:!1},ticks:{font:{size:o?20:14},callback(e){e=n.decodeHTMLEntities(this.getLabelForValue(e));return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{title(e){return e[0].label},label(e){return e.raw+"% ("+l.fieldData["field_"+t].chart.totals[e.dataIndex]+")"},labelColor(){return{backgroundColor:"#2b8fd2"}}}}}}}:"pie"===e?s={type:"pie",data:{labels:a.map(String),datasets:[{hoverBackgroundColor:"#2b8fd2",data:r.map(String),backgroundColor:randomColor({luminosity:"light",count:r.length})}]},options:{responsive:!o,maintainAspectRatio:!1,plugins:{legend:{position:"right",align:"start",labels:{font:{size:o?20:14},padding:15,generateLabels(s){let i=s.data;return i.labels.length&&i.datasets.length?i.labels.map(function(e,t){var a=s.getDatasetMeta(0),r=i.datasets[0],o=s.options.elements.arc,o=r.backgroundColor[t]||o.backgroundColor;return{text:e="string"==typeof e&&20<e.length?e.substring(0,20)+"...":e,fillStyle:o,strokeStyle:o,lineWidth:1,hidden:isNaN(r.data[t])||a.data[t].hidden,index:t}}):[]}}},tooltip:{callbacks:{title(){return""},label(e){return e.label+` - ${e.formattedValue}% (${l.fieldData["field_"+t].chart.totals[e.dataIndex]})`},labelColor(){return{backgroundColor:"#2b8fd2"}}}}}}}:"line"===e&&(s={type:"line",data:{labels:a,datasets:[{label:"Data",borderColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",fill:!1,tension:.4,data:r}]},options:{responsive:!o,maintainAspectRatio:!1,scales:{x:{grid:{display:!1},ticks:{font:{size:o?20:14},callback(e){e=n.decodeHTMLEntities(this.getLabelForValue(e));return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}},y:{beginAtZero:!0,max:100,ticks:{stepSize:20,color:"#999999",font:{size:o?20:11},callback(e){return e+"%"}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{title(e){return e[0].label},label(e){return e.raw+"% ("+l.fieldData["field_"+t].chart.totals[e.dataIndex]+")"}}}}}}),s&&(o?l.charts["chart_hq_"+t]=new Chart("chart-"+t+"-hq",s):l.charts["chart_"+t]=new Chart("chart-"+t,s))}};n.init()})(jQuery);